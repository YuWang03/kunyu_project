# 薪資查詢驗證碼功能說明

## 功能概述

薪資查詢功能需要二次驗證，透過發送驗證碼到使用者的 Email 來確保安全性。

## API 流程

### 1. 發送驗證碼（POST /app/sendcode）

**步驟：**
1. APP 發送請求，包含 `tokenid`、`cid`、`uid`
2. 後端從資料庫查詢該使用者的 Email（`EMPLOYEE_EMAIL_1`）
3. 產生 4 位數隨機驗證碼（1000-9999）
4. 將驗證碼儲存到資料庫 `SalaryVerificationCodes` 資料表
5. 透過 SMTP 發送驗證碼到使用者的 Email
6. 回傳成功或失敗訊息

**驗證碼有效期：**
- 預設：**5 分鐘**
- 可在 `appsettings.json` 的 `SalaryVerification.CodeExpirationMinutes` 調整

**Email 設定：**
- Host: `mail.panpi.com.tw`
- Port: `25`
- 寄件者: `administrator@panpi.com.tw`
- 密碼: `admin0720`

### 2. 驗證驗證碼（POST /app/sendcodecheck）

**步驟：**
1. APP 發送請求，包含 `tokenid`、`cid`、`uid`、`verificationcode`
2. 後端從資料庫查詢該使用者的驗證碼記錄
3. 檢查驗證碼是否正確
4. 檢查驗證碼是否在有效期內（5 分鐘）
5. 檢查驗證碼是否已被使用過
6. 驗證成功後，標記驗證碼為已使用（一次性使用）
7. 回傳成功或失敗訊息

**萬用測試驗證碼：**
- 驗證碼：`0000`
- 用途：方便測試，不需從信箱取得驗證碼
- 使用時機：由於目前員工的 Email 多為測試用（如 z0001@test.com），無法實際收信
- 驗證邏輯：當輸入 `0000` 時，直接回傳驗證成功，不檢查資料庫

### 3. 查詢薪資明細（POST /app/salaryview）

**前置條件：**
- 必須先通過驗證碼驗證（步驟 2）
- 驗證成功後才能查詢薪資明細

## 資料庫結構

### 資料表：SalaryVerificationCodes

```sql
CREATE TABLE [dbo].[SalaryVerificationCodes] (
    [Cid] NVARCHAR(50) NOT NULL,          -- 公司代碼
    [Uid] NVARCHAR(50) NOT NULL,          -- 使用者工號
    [Code] NVARCHAR(10) NOT NULL,         -- 驗證碼（4 位數）
    [CreatedAt] DATETIME NOT NULL,        -- 建立時間
    [ExpiresAt] DATETIME NOT NULL,        -- 過期時間
    [IsUsed] BIT NOT NULL DEFAULT 0,      -- 是否已使用（0=未使用, 1=已使用）
    PRIMARY KEY ([Cid], [Uid])
);
```

**建立資料表：**
執行 `docs/SQL_CreateSalaryVerificationCodesTable.sql` 腳本

**清理過期驗證碼：**
```sql
EXEC [dbo].[sp_CleanExpiredVerificationCodes];
```

## 設定檔案（appsettings.json）

```json
{
  "SmtpSettings": {
    "Host": "mail.panpi.com.tw",
    "Port": 25,
    "Username": "administrator@panpi.com.tw",
    "Password": "admin0720",
    "FromEmail": "administrator@panpi.com.tw",
    "FromName": "廣宇科技人力資源系統"
  },
  "SalaryVerification": {
    "CodeExpirationMinutes": 5,
    "TestVerificationCode": "0000"
  }
}
```

## 測試步驟

### 1. 正常流程測試

```http
# Step 1: 發送驗證碼
POST http://localhost:5112/app/sendcode
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325"
}

# Step 2: 檢查 Email 或資料庫取得驗證碼
# SELECT * FROM [SalaryVerificationCodes] WHERE Uid = '0325';

# Step 3: 驗證驗證碼
POST http://localhost:5112/app/sendcodecheck
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "verificationcode": "1234"  // 從 Email 或資料庫取得
}

# Step 4: 查詢薪資明細
POST http://localhost:5112/app/salaryview
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "querydate": "2025-09"
}
```

### 2. 使用萬用測試驗證碼

```http
# Step 1: 發送驗證碼（可省略，直接使用萬用碼）
# ...

# Step 2: 使用萬用測試驗證碼 0000
POST http://localhost:5112/app/sendcodecheck
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "verificationcode": "0000"  // 萬用測試驗證碼
}

# Step 3: 查詢薪資明細
# ...
```

## 錯誤處理

### 常見錯誤碼

- `200`：請求成功
- `203`：請求失敗，主要條件不符合

### 驗證碼驗證失敗原因

1. **找不到驗證碼**
   - 使用者尚未請求驗證碼
   - 驗證碼已過期（超過 5 分鐘）

2. **驗證碼已被使用**
   - 驗證碼只能使用一次
   - 需重新請求新的驗證碼

3. **驗證碼不正確**
   - 輸入的驗證碼與資料庫記錄不符

4. **驗證碼已過期**
   - 超過 5 分鐘有效期限

## 安全性考量

1. **驗證碼有效期限**
   - 預設 5 分鐘，可調整
   - 過期後需重新請求

2. **一次性使用**
   - 驗證碼驗證成功後立即標記為已使用
   - 防止驗證碼重複使用

3. **自動清理**
   - 建議定期執行 `sp_CleanExpiredVerificationCodes` 清理過期記錄
   - 減少資料表大小，提升查詢效能

4. **萬用測試碼**
   - 僅供測試環境使用
   - 正式環境建議移除或變更為更複雜的值

## 維護建議

1. **定期清理過期驗證碼**
   - 建立 SQL Server Agent Job
   - 每小時執行一次 `sp_CleanExpiredVerificationCodes`

2. **監控 Email 發送狀況**
   - 檢查 SMTP 連線狀態
   - 確認 Email 是否成功送達

3. **調整驗證碼有效期限**
   - 根據實際使用情況調整
   - 平衡安全性與使用者體驗

## 日誌查詢

```csharp
// 查看驗證碼發送日誌
_logger.LogInformation($"驗證碼已產生: {verificationCode}，將於 {expiresAt:yyyy-MM-dd HH:mm:ss} 過期");

// 查看驗證碼驗證日誌
_logger.LogInformation($"使用者 {request.Uid} 驗證碼驗證成功");

// 查看萬用測試碼使用日誌
_logger.LogInformation($"使用者 {request.Uid} 使用測試萬用驗證碼驗證成功");
```
