# 薪資查詢驗證碼功能 - 部署指南

## 📋 部署清單

### ✅ 已完成項目

1. **程式碼修改**
   - ✅ `SalaryModels.cs` - 加入驗證碼 Model
   - ✅ `Settings.cs` - 加入 SMTP 和驗證設定 Model
   - ✅ `SalaryService.cs` - 實作驗證碼發送和驗證邏輯
   - ✅ `SalaryController.cs` - API 端點
   - ✅ `Program.cs` - 註冊服務和設定
   - ✅ `appsettings.json` - 加入 SMTP 和驗證設定

2. **文件**
   - ✅ `docs/薪資查詢驗證碼功能說明.md` - 功能說明
   - ✅ `docs/SQL_CreateSalaryVerificationCodesTable.sql` - 資料表建立腳本
   - ✅ `salary-api-test.http` - API 測試檔案

### ⚠️ 待執行項目（需資料庫管理員協助）

1. **建立資料表**
   - ⚠️ 執行 SQL 腳本建立 `SalaryVerificationCodes` 資料表
   - ⚠️ 建立索引以提升查詢效能
   - ⚠️ 建立清理過期驗證碼的預存程序

## 🗄️ 資料庫部署步驟

### 步驟 1：建立資料表

請資料庫管理員執行以下 SQL 腳本（位於 `docs/SQL_CreateSalaryVerificationCodesTable.sql`）：

```sql
USE [03546618];
GO

CREATE TABLE [dbo].[SalaryVerificationCodes] (
    [Cid] NVARCHAR(50) NOT NULL,          -- 公司代碼
    [Uid] NVARCHAR(50) NOT NULL,          -- 使用者工號
    [Code] NVARCHAR(10) NOT NULL,         -- 驗證碼（4 位數）
    [CreatedAt] DATETIME NOT NULL,        -- 建立時間
    [ExpiresAt] DATETIME NOT NULL,        -- 過期時間
    [IsUsed] BIT NOT NULL DEFAULT 0,      -- 是否已使用
    CONSTRAINT [PK_SalaryVerificationCodes] PRIMARY KEY CLUSTERED 
    (
        [Cid] ASC,
        [Uid] ASC
    )
);

-- 建立索引
CREATE NONCLUSTERED INDEX [IX_SalaryVerificationCodes_CreatedAt]
ON [dbo].[SalaryVerificationCodes] ([CreatedAt] DESC);

CREATE NONCLUSTERED INDEX [IX_SalaryVerificationCodes_ExpiresAt]
ON [dbo].[SalaryVerificationCodes] ([ExpiresAt] ASC);
GO
```

### 步驟 2：建立清理預存程序

```sql
CREATE PROCEDURE [dbo].[sp_CleanExpiredVerificationCodes]
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @DeletedCount INT;
    
    DELETE FROM [dbo].[SalaryVerificationCodes]
    WHERE ExpiresAt < DATEADD(HOUR, -24, GETDATE());
    
    SET @DeletedCount = @@ROWCOUNT;
    
    PRINT '已刪除 ' + CAST(@DeletedCount AS NVARCHAR(10)) + ' 筆過期的驗證碼記錄。';
END
GO
```

### 步驟 3：驗證資料表

```sql
-- 查詢資料表是否存在
SELECT * FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_NAME = 'SalaryVerificationCodes';

-- 查詢資料表結構
EXEC sp_help 'SalaryVerificationCodes';

-- 查詢索引
EXEC sp_helpindex 'SalaryVerificationCodes';
```

## 📧 SMTP 設定確認

### appsettings.json 設定

```json
{
  "SmtpSettings": {
    "Host": "mail.panpi.com.tw",
    "Port": 25,
    "Username": "administrator@panpi.com.tw",
    "Password": "admin0720",
    "FromEmail": "administrator@panpi.com.tw",
    "FromName": "廣宇科技人力資源系統"
  },
  "SalaryVerification": {
    "CodeExpirationMinutes": 5,
    "TestVerificationCode": "0000"
  }
}
```

### SMTP 連線測試

可以使用以下 PowerShell 腳本測試 SMTP 連線：

```powershell
$smtpServer = "mail.panpi.com.tw"
$smtpPort = 25
$from = "administrator@panpi.com.tw"
$to = "test@example.com"
$subject = "SMTP 測試"
$body = "這是一封測試郵件"

$credential = New-Object System.Management.Automation.PSCredential(
    "administrator@panpi.com.tw",
    (ConvertTo-SecureString "admin0720" -AsPlainText -Force)
)

Send-MailMessage -SmtpServer $smtpServer -Port $smtpPort `
    -From $from -To $to -Subject $subject -Body $body `
    -Credential $credential
```

## 🧪 測試步驟

### 測試 1：完整流程（使用真實驗證碼）

1. **發送驗證碼**
```http
POST http://localhost:5112/app/sendcode
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325"
}
```

2. **從資料庫查詢驗證碼**（因為測試帳號無法收信）
```sql
SELECT TOP 1 * FROM [SalaryVerificationCodes] 
WHERE Uid = '0325' 
ORDER BY CreatedAt DESC;
```

3. **驗證驗證碼**
```http
POST http://localhost:5112/app/sendcodecheck
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "verificationcode": "1234"  // 從資料庫取得
}
```

4. **查詢薪資明細**
```http
POST http://localhost:5112/app/salaryview
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "querydate": "2025-09"
}
```

### 測試 2：使用萬用測試驗證碼

1. **直接驗證（使用 0000）**
```http
POST http://localhost:5112/app/sendcodecheck
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "verificationcode": "0000"  // 萬用測試碼
}
```

2. **查詢薪資明細**
```http
POST http://localhost:5112/app/salaryview
Content-Type: application/json

{
  "tokenid": "53422421",
  "cid": "45624657",
  "uid": "0325",
  "querydate": "2025-09"
}
```

## 🔍 故障排除

### 問題 1：資料表不存在

**錯誤訊息：**
```
Invalid object name 'SalaryVerificationCodes'
```

**解決方法：**
1. 確認資料表是否已建立
2. 執行 `docs/SQL_CreateSalaryVerificationCodesTable.sql` 腳本
3. 聯繫資料庫管理員確認權限

### 問題 2：SMTP 發送失敗

**錯誤訊息：**
```
發送 Email 失敗
```

**解決方法：**
1. 確認 SMTP 伺服器是否可連線
2. 確認帳號密碼是否正確
3. 確認防火牆是否允許 Port 25
4. 使用萬用測試驗證碼 `0000` 繼續測試

### 問題 3：找不到使用者

**錯誤訊息：**
```
找不到使用者資料
```

**解決方法：**
1. 確認使用者工號是否存在於 `vwZZ_EMPLOYEE` 視圖
2. 確認使用者是否有設定 Email（`EMPLOYEE_EMAIL_1`）

### 問題 4：驗證碼已過期

**錯誤訊息：**
```
驗證碼已過期
```

**解決方法：**
1. 重新請求驗證碼
2. 如需調整過期時間，修改 `appsettings.json` 的 `CodeExpirationMinutes`

## 📊 監控與維護

### 日誌監控

在 `appsettings.json` 中調整日誌等級：

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "HRSystemAPI.Services.SalaryService": "Debug"
    }
  }
}
```

### 定期清理過期驗證碼

建議設定 SQL Server Agent Job，每小時執行一次：

```sql
EXEC [dbo].[sp_CleanExpiredVerificationCodes];
```

### 監控指標

1. **驗證碼發送成功率**
```sql
-- 過去 24 小時發送的驗證碼數量
SELECT COUNT(*) as TotalCodes
FROM [SalaryVerificationCodes]
WHERE CreatedAt > DATEADD(HOUR, -24, GETDATE());
```

2. **驗證成功率**
```sql
-- 已使用的驗證碼數量
SELECT COUNT(*) as UsedCodes
FROM [SalaryVerificationCodes]
WHERE IsUsed = 1 AND CreatedAt > DATEADD(HOUR, -24, GETDATE());
```

3. **過期率**
```sql
-- 過期未使用的驗證碼數量
SELECT COUNT(*) as ExpiredCodes
FROM [SalaryVerificationCodes]
WHERE IsUsed = 0 AND ExpiresAt < GETDATE();
```

## 🚀 上線前檢查清單

- [ ] 資料表 `SalaryVerificationCodes` 已建立
- [ ] 索引已建立
- [ ] 清理預存程序已建立
- [ ] SMTP 設定已確認
- [ ] 測試用驗證碼 `0000` 已設定
- [ ] API 測試通過（sendcode、sendcodecheck、salaryview）
- [ ] 日誌等級已設定
- [ ] SQL Server Agent Job 已設定（清理過期驗證碼）
- [ ] 文件已交付（功能說明、部署指南）

## 📞 聯繫資訊

如有問題，請聯繫：
- 開發團隊：[開發人員聯繫方式]
- 資料庫管理員：[DBA 聯繫方式]
- 系統管理員：[SA 聯繫方式]

---

**最後更新：** 2025-12-08  
**版本：** 1.0
