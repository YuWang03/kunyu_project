# ğŸ§ª ç„¡å¸³è™Ÿæ¸¬è©¦æŒ‡å—

## å¿«é€Ÿé–‹å§‹

ç•¶ä½ æ²’æœ‰æ¸¬è©¦å¸³è™Ÿæ™‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ç¨®æ–¹æ³•æ¸¬è©¦ä½ çš„ Keycloak OIDC æ•´åˆã€‚

---

## ğŸ“‹ æ–¹æ³•å°æ¯”

| æ–¹æ³• | éœ€è¦å¸³è™Ÿ | é©ç”¨å ´æ™¯ | æ¸¬è©¦ç¯„åœ |
|------|---------|----------|---------|
| **è‡ªå‹•åŒ–æ¸¬è©¦** | âŒ ä¸éœ€è¦ | é©—è­‰åŸºç¤è¨­å®š | Keycloak é€£ç·šã€ç’°å¢ƒè®Šæ•¸ã€JWT è§£ç¢¼ |
| **Mock Token** | âŒ ä¸éœ€è¦ | æ¸¬è©¦ API é‚è¼¯ | Token è§£æã€æ¬Šé™é©—è­‰ã€API å›æ‡‰ |
| **Postman Collection** | âŒ ä¸éœ€è¦ | æ‰‹å‹•æ¸¬è©¦ | API ç«¯é»ã€è«‹æ±‚æ ¼å¼ã€å›æ‡‰é©—è­‰ |
| **çœŸå¯¦ç™»å…¥** | âœ… éœ€è¦ | å®Œæ•´æ¸¬è©¦ | ç«¯åˆ°ç«¯å®Œæ•´æµç¨‹ |

---

## ğŸš€ æ–¹æ³•ä¸€ï¼šè‡ªå‹•åŒ–æ¸¬è©¦ï¼ˆæ¨è–¦ï¼‰

### åŸ·è¡Œæ¸¬è©¦

```bash
cd keycloak_login_demo
node api_test.js
```

### æ¸¬è©¦å…§å®¹

```
âœ… ç’°å¢ƒè®Šæ•¸é…ç½®æª¢æŸ¥
âœ… Client ID æ ¼å¼é©—è­‰
âœ… JWT è§£ç¢¼åŠŸèƒ½æ¸¬è©¦
âœ… Token Endpoint å¯è¨ªå•æ€§
âœ… éŒ¯èª¤æ†‘è­‰è™•ç†æ¸¬è©¦
âœ… æœ¬åœ° API é€£ç·šæ¸¬è©¦
```

### é æœŸè¼¸å‡º

```
ğŸ§ª é–‹å§‹åŸ·è¡Œ Keycloak & API æ•´åˆæ¸¬è©¦
============================================================

âš™ï¸  æ¸¬è©¦ 5: ç’°å¢ƒè®Šæ•¸é…ç½®
------------------------------------------------------------
   âœ… REALM: å·²è¨­å®š
   âœ… TOKEN_URL: å·²è¨­å®š
   âœ… CLIENT_ID: å·²è¨­å®š
   âš ï¸  USERNAME: æœªè¨­å®šæˆ–ä½¿ç”¨é è¨­å€¼
   âš ï¸  PASSWORD: æœªè¨­å®šæˆ–ä½¿ç”¨é è¨­å€¼
âœ… PASS - ç’°å¢ƒè®Šæ•¸é…ç½®

ğŸ“ æ¸¬è©¦ 4: Client ID æ ¼å¼é©—è­‰
------------------------------------------------------------
âœ… PASS - Client ID æ ¼å¼
   Client ID æ ¼å¼æ­£ç¢º: ZZ_EMPLOYEE2k7

ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦
============================================================
ç¸½æ¸¬è©¦æ•¸: 6
âœ… é€šé: 6
âŒ å¤±æ•—: 0
æˆåŠŸç‡: 100.0%
```

---

## ğŸ­ æ–¹æ³•äºŒï¼šMock Token ç”Ÿæˆ

### æ­¥é©Ÿ 1: ç”Ÿæˆ Mock Token

```bash
node mock_token_test.js
```

### æ­¥é©Ÿ 2: è¤‡è£½ Token

è¼¸å‡ºæœƒåŒ…å«ï¼š
```
ğŸ”‘ Mock Access Token:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3OC0x...
```

### æ­¥é©Ÿ 3: åœ¨ Postman æˆ– cURL ä¸­ä½¿ç”¨

**Postman:**
```
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**cURL:**
```bash
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
     https://localhost:7001/api/BasicInformation/GetEmployeeBasicInfo
```

### æ­¥é©Ÿ 4: åœ¨ä½ çš„ API ä¸­è§£ç¢¼ Token

```csharp
// C# ç¯„ä¾‹ï¼šåœ¨ä½ çš„ API Controller ä¸­
[Authorize]
[HttpGet]
public IActionResult GetEmployeeInfo()
{
    // å¾ Header å–å¾— token
    var token = Request.Headers["Authorization"].ToString().Replace("Bearer ", "");
    
    // è§£ç¢¼ token (ä¸é©—è­‰ç°½åï¼Œåƒ…ä¾›é–‹ç™¼æ¸¬è©¦)
    var handler = new JwtSecurityTokenHandler();
    var jwtToken = handler.ReadJwtToken(token);
    
    // å–å¾—ç”¨æˆ¶è³‡è¨Š
    var email = jwtToken.Claims.FirstOrDefault(c => c.Type == "email")?.Value;
    var username = jwtToken.Claims.FirstOrDefault(c => c.Type == "preferred_username")?.Value;
    
    return Ok(new { email, username });
}
```

### Mock Token åŒ…å«çš„è³‡è¨Š

```json
{
  "sub": "12345678-1234-1234-1234-123456789012",
  "email": "test.user@company.com",
  "preferred_username": "test.user",
  "name": "æ¸¬è©¦ç”¨æˆ¶",
  "given_name": "æ¸¬è©¦",
  "family_name": "ç”¨æˆ¶",
  "employee_id": "EMP001",
  "department": "IT",
  "realm_access": {
    "roles": ["employee", "user"]
  }
}
```

---

## ğŸ“® æ–¹æ³•ä¸‰ï¼šPostman Collection

### æ­¥é©Ÿ 1: åŒ¯å…¥ Collection

1. æ‰“é–‹ Postman
2. é»æ“Š **Import**
3. é¸æ“‡ `Keycloak-Mock-Tests.postman_collection.json`

### æ­¥é©Ÿ 2: è¨­å®šè®Šæ•¸

åœ¨ Collection è®Šæ•¸ä¸­è¨­å®šï¼š
```
base_url = https://localhost:7001  (ä½ çš„ API URL)
keycloak_url = https://sso.panpi.com.cn
realm = Panpi_TP
client_id = ZZ_EMPLOYEE2k7
```

### æ­¥é©Ÿ 3: åŸ·è¡Œæ¸¬è©¦

**è³‡æ–™å¤¾ 1: æ¸¬è©¦ Keycloak é€£ç·š** âŒ ç„¡éœ€å¸³è™Ÿ
- æ¸¬è©¦ Token Endpoint (éŒ¯èª¤æ†‘è­‰) â†’ é æœŸæ”¶åˆ° 401
- ç²å– Realm å…¬é‘° â†’ æª¢æŸ¥ Keycloak è¨­å®š

**è³‡æ–™å¤¾ 2: ä½¿ç”¨ Mock Token æ¸¬è©¦ API** âŒ ç„¡éœ€å¸³è™Ÿ
- æ¸¬è©¦ API Health Check
- æ¸¬è©¦å—ä¿è­·çš„ API (Mock Token)
- æ¸¬è©¦è«‹å‡ API (Mock Token)

**è³‡æ–™å¤¾ 3: çœŸå¯¦ç™»å…¥æ¸¬è©¦** âœ… éœ€è¦å¸³è™Ÿ
- ç™»å…¥å–å¾— Token
- ä½¿ç”¨çœŸå¯¦ Token æ¸¬è©¦ API

---

## ğŸ” é©—è­‰ä½ çš„ API æ˜¯å¦æ­£ç¢ºè™•ç† Token

### æ¸¬è©¦æ¸…å–®

- [ ] API èƒ½æ­£ç¢ºè§£æ Authorization Header
- [ ] API èƒ½è§£ç¢¼ JWT Token
- [ ] API èƒ½å¾ Token ä¸­æå–ç”¨æˆ¶è³‡è¨Š (email, username)
- [ ] API èƒ½é©—è­‰ Token çš„æœ‰æ•ˆæœŸé™
- [ ] API èƒ½è™•ç†ç„¡æ•ˆæˆ–éæœŸçš„ Token
- [ ] API èƒ½æ ¹æ“š Token ä¸­çš„ roles åšæ¬Šé™æ§åˆ¶

### æ¸¬è©¦ç¯„ä¾‹

```bash
# 1. ç”Ÿæˆ Mock Token
node mock_token_test.js

# 2. è¤‡è£½è¼¸å‡ºçš„ token

# 3. æ¸¬è©¦ä½ çš„ API
curl -X GET https://localhost:7001/api/BasicInformation/GetEmployeeBasicInfo \
  -H "Authorization: Bearer <YOUR_MOCK_TOKEN>" \
  -k

# 4. æª¢æŸ¥ API æ˜¯å¦æ­£ç¢ºå›æ‡‰
```

---

## âš ï¸ é‡è¦æé†’

### Mock Token çš„é™åˆ¶

1. **åƒ…ä¾›é–‹ç™¼æ¸¬è©¦**ï¼šMock Token ä¸èƒ½ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ
2. **ç„¡ç°½åé©—è­‰**ï¼šä¸æœƒé€²è¡ŒçœŸæ­£çš„ç°½åé©—è­‰
3. **è‡ªè¨‚å…§å®¹**ï¼šå¯ä»¥åœ¨ `mock_token_test.js` ä¸­è‡ªè¨‚ payload
4. **ä¸æœƒéæœŸ**ï¼šé è¨­è¨­å®šç‚ºå¾ˆæ™šæ‰éæœŸï¼ˆç”¨æ–¼æ¸¬è©¦æ–¹ä¾¿ï¼‰

### ä½•æ™‚éœ€è¦çœŸå¯¦å¸³è™Ÿ

- âœ… **ä¸éœ€è¦çœŸå¯¦å¸³è™Ÿ**ï¼š
  - æ¸¬è©¦ API çš„ token è§£æé‚è¼¯
  - é–‹ç™¼å’Œèª¿è©¦ API ç«¯é»
  - è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
  - CI/CD æµç¨‹ä¸­çš„å–®å…ƒæ¸¬è©¦

- âš ï¸ **éœ€è¦çœŸå¯¦å¸³è™Ÿ**ï¼š
  - é©—è­‰å®Œæ•´çš„ OIDC æµç¨‹
  - æ¸¬è©¦ Token ç°½åé©—è­‰
  - æ¸¬è©¦ Refresh Token æ©Ÿåˆ¶
  - æ•´åˆæ¸¬è©¦å’Œ UAT ç’°å¢ƒ
  - ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å‰çš„é©—è­‰

---

## ğŸ“Š å®Œæ•´æ¸¬è©¦æµç¨‹

```
é–‹å§‹
  â†“
[1] åŸ·è¡Œ api_test.js
  â†“
æª¢æŸ¥åŸºç¤è¨­å®šæ˜¯å¦æ­£ç¢º
  â†“
[2] åŸ·è¡Œ mock_token_test.js
  â†“
ç”Ÿæˆ Mock Token
  â†“
[3] ä½¿ç”¨ Mock Token æ¸¬è©¦ API
  â†“
é©—è­‰ API é‚è¼¯æ­£ç¢º
  â†“
[4] ä½¿ç”¨ Postman æ‰‹å‹•æ¸¬è©¦
  â†“
ç¢ºèªå„ç¨®å ´æ™¯
  â†“
æº–å‚™å¥½çœŸå¯¦å¸³è™Ÿå¾Œ
  â†“
[5] åŸ·è¡Œ keycloak_login.js
  â†“
å®Œæ•´ç«¯åˆ°ç«¯æ¸¬è©¦
  â†“
å®Œæˆï¼
```

---

## ğŸ†˜ ç–‘é›£æ’è§£

### å•é¡Œ 1: api_test.js åŸ·è¡Œå¤±æ•—

**éŒ¯èª¤ï¼š** `Error: Missing required environment variables`

**è§£æ±ºï¼š**
```bash
# æª¢æŸ¥ .env æª”æ¡ˆæ˜¯å¦å­˜åœ¨
ls .env

# ç¢ºèªå¿…è¦è®Šæ•¸å·²è¨­å®š
cat .env
```

### å•é¡Œ 2: Mock Token ç„¡æ³•ä½¿ç”¨

**éŒ¯èª¤ï¼š** API å›æ‡‰ 401 Unauthorized

**å¯èƒ½åŸå› ï¼š**
- API éœ€è¦é©—è­‰ Token ç°½åï¼ˆMock Token ä½¿ç”¨å‡ç°½åï¼‰
- API éœ€è¦çœŸå¯¦çš„ Keycloak Public Key

**è§£æ±ºï¼š**
- åœ¨é–‹ç™¼ç’°å¢ƒæš«æ™‚é—œé–‰ç°½åé©—è­‰
- æˆ–ä½¿ç”¨çœŸå¯¦å¸³è™Ÿå–å¾—çœŸå¯¦ Token

### å•é¡Œ 3: Postman æ¸¬è©¦å¤±æ•—

**éŒ¯èª¤ï¼š** `Could not get response`

**æª¢æŸ¥ï¼š**
1. API æ˜¯å¦æ­£åœ¨é‹è¡Œ
2. URL æ˜¯å¦æ­£ç¢º
3. é˜²ç«ç‰†/HTTPS è¨­å®š

---

## ğŸ“š ç›¸é—œè³‡æº

- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [JWT.io - Token è§£ç¢¼å·¥å…·](https://jwt.io/)
- [OpenID Connect è¦æ ¼](https://openid.net/connect/)
- [Postman Learning Center](https://learning.postman.com/)

---

**å»ºç«‹æ—¥æœŸï¼š** 2025-11-04  
**ç¶­è­·è€…ï¼š** GitHub Copilot
